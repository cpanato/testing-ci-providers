version: 2.1

jobs:
  test-webapp:
    machine:
      image: ubuntu-2004:202111-01
    environment:
      DOCKER_BUILDKIT: 1
      BUILDX_PLATFORMS: linux/amd64,linux/arm64,linux/arm/v7
    steps:
      - run:
          name: Update Go
          command: |
            GOLANG_URL="https://go.dev/dl/go1.16.11.linux-amd64.tar.gz"

            curl --output go1.16.11.linux-amd64.tar.gz \
              --silent --show-error --location --fail --retry 3 \
              "$GOLANG_URL"

            sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf go1.16.11.linux-amd64.tar.gz
            go version
      - run:
          name: Install buildx
          command: |
            BUILDX_BINARY_URL="https://github.com/docker/buildx/releases/download/v0.7.0/buildx-v0.7.0.linux-amd64"

            curl --output docker-buildx \
              --silent --show-error --location --fail --retry 3 \
              "$BUILDX_BINARY_URL"

            mkdir -p ~/.docker/cli-plugins

            mv docker-buildx ~/.docker/cli-plugins/
            chmod a+x ~/.docker/cli-plugins/docker-buildx

            docker buildx install
            # Run binfmt
            docker run --rm --privileged tonistiigi/binfmt:latest --install "$BUILDX_PLATFORMS"
      - run:
          name: checkout
          command: git clone https://github.com/cpanato/falcosidekick.git
      - run:
          name: Release
          command: curl -sL https://git.io/goreleaser | bash

workflows:
  version: 2
  ci-build:
    jobs:
    - test-webapp
