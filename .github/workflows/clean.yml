name: CleanDocker
on:
  pull_request:
    types: [closed, opened]

jobs:
  clean-docker:
    name: Clean Docker images for PR
    runs-on: ubuntu-latest
    steps:
    - name: Get Commits and delete
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: |
        echo "***Context***"
        echo $GITHUB_CONTEXT
        echo "******"

        PR=$(curl https://api.github.com/repos/cpanato/testing-ghactions/commits/"$GITHUB_SHA"/pulls --header 'Accept: application/vnd.github.groot-preview+json' | jq -r '.[] | .number')
        echo "***PR***"
        echo $PR
        echo "******"
        COMMITS_URL=$(echo $GITHUB_CONTEXT | jq -r '.event.pull_request._links.commits.href')
        COMMITS=$(curl $COMMITS_URL | jq -r '.[] | .sha')
        echo "***Commits***"
        echo $COMMITS
        echo "******"
        for commit in $COMMITS
        do
          echo "Deleting docker image ${commit:0:7}"
        done
        echo done
