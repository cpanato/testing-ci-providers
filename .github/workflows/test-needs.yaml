name: release-test-needs

on:
  workflow_dispatch:
    inputs:
      checkout_ref:
        required: false
        type: string
        default: ""
        description: "Commit ref (sha, branch, or tag) to run at."
  push:
    tags:
      - "v*"

permissions: {}

jobs:
  release-start-slack:
    name: start
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - run: echo "Starting Production release"

  infra-prereqs:
    name: infra-prereqs
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - run: echo "Starting infra prereq release"

  build-matrix:
    name: build-matrix
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - run: echo "Starting build-matrix release"

  sharded:
    name: sharded
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs:
      - infra-prereqs
      - build-matrix
    steps:
      - run: echo "Starting sharded release"

  release:
    uses: ./.github/workflows/.release-drop.yaml
    needs: ["infra-prereqs"]
    permissions:
      id-token: write
      contents: read
    with:
      checkout_ref: ${{ github.event.inputs.checkout_ref }}

  release-end-slack:
    name: release-end-slack
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs:
      - sharded
      - release
    steps:
      - run: echo "Done Production release"
